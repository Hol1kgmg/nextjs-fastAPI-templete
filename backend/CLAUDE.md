# CLAUDE.md

## 🚨 AI エージェント向け必読事項

### 読み込み順序
このドキュメントには、バックエンドプロジェクトのすべてのルールが記載されています。**上から下へ、順番にすべて読んでください。**

### 目次
- [重要: 基本原則](#重要-基本原則)
- [開発コマンド](#開発コマンド)
- [アーキテクチャ](#アーキテクチャ)
- [Python/FastAPI 設定](#pythonfastapi-設定)
- [詳細ガイドライン](#詳細ガイドライン)
  - [コード品質・作成ガイド](#コード品質作成ガイド)
  - [命名規則](#命名規則)
  - [型アノテーション ガイドライン](#型アノテーション-ガイドライン)
  - [テストガイドライン](#テストガイドライン)

---

## 重要: 基本原則

### 1. 日本語コミュニケーション

Claude Code は日本語でコミュニケーションを行う必要があります。すべてのコミットメッセージ、コメント、エラーメッセージ、ユーザーとのやり取りは日本語で行ってください。

### 2. 事前承認要件

**重要**: ファイルの作成、編集、削除を行う前に、必ず以下を報告し、明示的なユーザー承認を得てください：

- 対象ファイルのリスト
- 実行する変更の詳細説明
- 影響範囲の説明

### 3. 決定権限の原則

- **最終決定権限は常にユーザーにある**
- AI は勝手に代替アプローチや回避策を選択してはならない
- 不明な点がある場合は常に質問し、推測で進めてはならない

### 4. CLAUDE.md コンプライアンス確認

作業を開始する前に、このドキュメントの関連ルールとの適合性を確認し、それをユーザーに報告してください。

### 5. 標準ワークフロー

すべてのタスクに対して以下の手順に従ってください：

```yaml
ステップ 1: タスク理解
  - ユーザー要件を明確に理解する
  - 不明な点があれば質問する
  - 期待される成果物を確認する

ステップ 2: 計画立案
  - 詳細な実行計画を作成する
  - 影響を受けるファイルとシステムを特定する
  - リスクと考慮事項を評価する

ステップ 3: 事前報告
  - 計画をユーザーに報告する
  - 明示的な承認を得る
  - 承認なしに実行してはならない

ステップ 4: 実行
  - 計画に従って実行する
  - 予期しない状況を即座に報告する
  - 独断で決定を下してはならない

ステップ 5: 完了報告
  - 実行結果を詳細に報告する
  - 変更の確認を求める
  - 次のアクションを確認する
```

### 6. コード品質ツールの遵守

**重要**: Ruff と mypy は品質保証の重要な仕組みです：

- **絶対にコード品質ツールを無視してはならない**
- Ruff が修正する内容は、コード品質向上のための正しい変更
- mypy の警告やエラーは必ず対処する
- 自動修正に疑問がある場合は、まずユーザーに相談する

### 7. 関数定義スタイル

**重要**: すべての関数は適切な型アノテーションを持つ必要があります。async関数とsync関数を適切に使い分けること。

### 8. 型定義スタイル

**重要**: Pydantic モデルを積極的に活用し、型安全性を確保する。辞書型よりもPydanticモデルを優先すること。

### 9. コメントの原則

**原則として、コードにコメントを記述してはならない。** コードは、それ自体がドキュメントとなるように、明確で自己説明的であるべきです。

#### 例外的にコメントが許可されるケース
コメントは、以下のいずれかの条件を満たす場合にのみ許可されます。

1. **複雑なビジネスロジックの説明**:
   - アルゴリズムの「なぜ」を説明する場合
   - 「何をしているか」ではなく、「なぜその実装が必要なのか」を記述

2. **リンター/型チェッカー指示**:
   - `# type: ignore` や `# ruff: noqa` のような指示
   - なぜその無効化が必要なのかを簡潔に説明

3. **回避策（ワークアラウンド）の明示**:
   - ライブラリのバグや技術的制約による回避策
   - 理由と関連するIssueへのリンクを記述

### 10. プロジェクトルールの優先

**最重要**: このドキュメントに記載されているルールは、一般的なPythonのベストプラクティスよりも**常に優先されます**。コード生成やファイル操作の際は、常にこのドキュメントのルールが絶対的な基準となります。

### 11. 必須チェックリスト

操作前に以下のチェックリストを実行してください：

#### ファイル操作前

- [ ] **`ls -la`コマンド等で、操作対象のディレクトリの現在の状態を確認済み**
- [ ] 関連する CLAUDE.md ルールを確認済み
- [ ] 対象ファイルの現在の状態を理解済み
- [ ] 変更による影響範囲を特定済み
- [ ] 明示的なユーザー承認を取得済み
- [ ] バックアップと復旧方法を考慮済み

#### コード生成/編集前

- [ ] プロジェクトの命名規則を確認済み
- [ ] 既存のコードスタイルを理解済み
- [ ] 依存関係と技術スタックを確認済み
- [ ] テストと品質要件を確認済み
- [ ] 型アノテーションを適切に追加することを確認済み
- [ ] Pydantic モデルの使用を検討済み
- [ ] **コメントの原則（ルール9）に従い、不要なコメントを記述していないことを確認済み**

#### Git 操作前

- [ ] 変更が意図通りであることを確認済み
- [ ] コミットメッセージガイドラインを確認済み
- [ ] ブランチング戦略を理解済み
- [ ] プッシュ前の最終検証を実行済み
- [ ] **Ruff と mypy を絶対に無視しない**

## 開発コマンド

### 基本コマンド

- `task install` - 依存関係をインストール（uv sync --group dev）
- `task dev` - 開発サーバーを開始（FastAPI + uvicorn）
- `task test` - pytest でテストを実行

### コード品質コマンド

- `task lint` - Ruff でリンティングチェックを実行
- `task format` - Ruff でコードを自動フォーマット
- `task typecheck` - mypy で型チェックを実行

### マイグレーションコマンド

- `task migrate` - 自動マイグレーション（生成＋適用）
- `task migrate:generate` - マイグレーション生成のみ
- `task migrate:upgrade` - 手動アップグレード（全て適用）
- `task migrate:downgrade` - 1つ前にダウングレード
- `task migrate:status` - 現在の状態表示
- `task migrate:history` - 履歴表示
- `task migrate:reset` - データベースリセット（全てダウングレード）

### Docker コマンド

- `task docker:build` - Docker イメージをビルド
- `task docker:up` - Docker コンテナを起動（PostgreSQL + FastAPI）
- `task docker:down` - Docker コンテナを停止
- `task clean` - 生成ファイルをクリーンアップ

## アーキテクチャ

### 技術スタック

- **フレームワーク**: FastAPI
- **言語**: Python 3.11
- **データベース**: PostgreSQL
- **パッケージマネージャー**: uv
- **タスクランナー**: Task
- **リンター/フォーマッター**: Ruff
- **型チェッカー**: mypy
- **テスト**: pytest
- **マイグレーション**: Alembic + 自動マイグレーションツール
- **コンテナ**: Docker

### プロジェクト構造

```
backend/
├── src/                    # ソースコード
│   ├── main.py            # FastAPI アプリケーション
│   ├── api/               # API ルート
│   ├── models/            # Pydantic モデル
│   ├── services/          # ビジネスロジック
│   ├── db/                # データベース関連
│   │   ├── database.py    # データベース接続
│   │   ├── models/        # SQLAlchemy モデル群
│   │   └── migrations/    # Alembic マイグレーション
│   ├── script/            # ユーティリティスクリプト
│   │   └── auto_migrate/  # 自動マイグレーションツール
│   └── utils/             # ユーティリティ関数
├── tests/                  # テストコード
├── docker/                 # Docker 設定
│   ├── docker-compose.yml # PostgreSQL + FastAPI
│   └── Dockerfile         # FastAPI コンテナ
├── pyproject.toml          # プロジェクト設定
├── .mise.toml              # mise 設定
└── Taskfile.yml            # タスク定義
```

### アプリケーションアーキテクチャ

- **API レイヤー**: `src/api/` - FastAPI ルートとエンドポイント
- **サービスレイヤー**: `src/services/` - ビジネスロジック
- **モデルレイヤー**: `src/models/` - Pydantic モデルとスキーマ
- **データベースレイヤー**: `src/db/` - PostgreSQL接続、SQLAlchemyモデル、マイグレーション
- **ユーティリティ**: `src/utils/` - 共通ユーティリティ関数

### データベース設計原則

- **SQLAlchemy ORM**: データベースアクセスにSQLAlchemyを使用
- **Alembic**: データベースマイグレーション管理
- **自動マイグレーション**: 意味のあるファイル名を自動生成するマイグレーションシステム
- **接続プール**: 効率的なデータベース接続管理
- **トランザクション**: 適切なトランザクション境界の設定

### Package by Feature アーキテクチャ

**核心原則**: 機能によって関連するコードをグループ化する。機能固有のロジックは、それを使用するAPIエンドポイントの近くに配置する。

#### ディレクトリ組織ルール

1. **グローバルユーティリティ**: 真にジェネリックな関数は `src/utils/` に配置
2. **機能固有ロジック**: 機能に固有のサービス、モデル、ユーティリティは機能ディレクトリ内に配置
3. **コロケーション**: 関連するコードは可能な限り使用される場所の近くに配置

## Python/FastAPI 設定

### セットアップ

- **Python バージョン**: 3.11
- **データベース**: PostgreSQL 15+
- **ORM**: SQLAlchemy 2.0+
- **マイグレーション**: Alembic
- **パッケージマネージャー**: uv
- **ASGI サーバー**: uvicorn
- **バリデーション**: Pydantic v2
- **型チェック**: mypy (strict mode)

### 重要な設定

- **pyproject.toml**: プロジェクト設定、依存関係、ツール設定
- **Ruff**: line-length=88, 包括的なルールセット
- **mypy**: 厳格な型チェック設定
- **pytest**: テスト設定とパス

---

## 詳細ガイドライン

## コード品質・作成ガイド

### 型アノテーション要件

**必須**: すべての関数、メソッド、変数に適切な型アノテーションを追加する。

- 関数の引数と戻り値に型アノテーションを必須とする
- Optional型、List型、Dict型を適切に使用する
- Pydantic BaseModelを活用した型定義を推奨する

### Pydantic モデル活用

**原則**: データの入出力には必ずPydanticモデルを使用する。

- リクエスト/レスポンスモデルの定義
- バリデーション機能の活用
- 型安全性の確保
- 辞書型よりもPydanticモデルを優先

### データベース操作パターン

**原則**: SQLAlchemyを使用したデータベース操作パターンを統一する。

- SQLAlchemyモデルの適切な定義
- セッション管理の統一
- トランザクション境界の明確化
- 非同期処理との適切な組み合わせ

### エラーハンドリング

**原則**: 適切な例外処理とHTTPステータスコードを使用する。

- FastAPI HTTPExceptionの活用
- 適切なステータスコードの選択
- 日本語エラーメッセージの提供
- ログ出力との連携

## 命名規則

### Python 命名規則

**原則**: PEP 8 に従った命名規則を使用する。

### 基本規則
- **関数・変数**: snake_case
- **クラス**: PascalCase
- **定数**: UPPER_SNAKE_CASE
- **プライベート**: 先頭にアンダースコア (_private_method)

### FastAPI 固有の命名

- **エンドポイント関数**: 動詞 + 名詞の組み合わせ（get_user_list, create_user_account）
- **Pydantic モデル**: 目的を明確にした命名（UserCreateRequest, UserUpdateRequest, UserResponse）
- **サービス関数**: ビジネスロジックを表現した命名
- **データベースモデル**: テーブル名との対応を考慮した命名

## 型アノテーション ガイドライン

### 必須型アノテーション

**すべての関数に型アノテーションが必要**:

- 関数の引数と戻り値に型アノテーションを必須とする
- 非同期関数でも同様に型アノテーションを追加
- 複雑な型はtypingモジュールを活用
- 変数アノテーションは必要に応じて追加

### Pydantic との組み合わせ

- BaseModelを継承したモデル定義
- Fieldを使用したバリデーション設定
- Optional型の適切な使用
- デフォルト値の設定

### mypy 設定遵守

プロジェクトは厳格な mypy 設定を使用しています：

- `strict = true`
- `disallow_untyped_defs = true`
- `warn_return_any = true`

## テストガイドライン

### pytest のインポート要件

**重要**: pytest の関数は明示的にインポートする必要があります。

### テストタイトルの日本語化

**重要**: すべてのテストタイトルは日本語で記述してください。

- テスト対象の機能を明確に表現
- 正常系・異常系の区別を明記
- 期待される結果を含める

### テストの種類と目的

#### API テスト
FastAPI エンドポイントの動作を検証：

- HTTPステータスコードの確認
- レスポンス形式の検証
- 認証・認可の動作確認
- エラーハンドリングの検証

#### サービステスト
ビジネスロジックの単体テスト：

- 純粋な関数のテスト
- ビジネスルールの検証
- データ変換処理の確認
- 条件分岐の網羅

#### モデルテスト
Pydantic モデルのバリデーションテスト：

- 正常なデータでの動作確認
- バリデーションエラーの検証
- デフォルト値の動作確認
- 型変換の動作確認

#### データベーステスト
PostgreSQL を使用したデータベース操作のテスト：

- CRUD操作の検証
- トランザクション動作の確認
- 制約違反の処理確認
- パフォーマンステスト

### テスト構造ルール

1. **AAA パターン**: Arrange-Act-Assert の構造を使用
2. **1テスト1検証**: 1つのテストで1つのことを検証
3. **日本語テスト名**: テストの意図が明確にわかる日本語名
4. **適切なアサーション**: 具体的で意味のあるアサーション

### テストカバレッジ目標

- **API エンドポイント**: 100%
- **サービス層**: 90%以上
- **データベース層**: 85%以上
- **ユーティリティ関数**: 100%
- **プロジェクト全体**: 85%以上

## AIエージェント向け重要な注意事項

コードの作成や修正を行う前には、必ずユーザーの承認を得てください。その際、適用する型アノテーション、Pydantic モデルの設計、テスト戦略を含んだ、明確な計画を提示することが求められます。