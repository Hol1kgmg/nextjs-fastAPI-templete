version: '3'

tasks:
  list:
    desc: Display available task commands for backend
    cmds:
      - echo "ğŸ“‹ Available backend task commands:"
      - task --list

  install:
    desc: "[Backend] Install dependencies using uv"
    dir: backend
    cmds:
      - uv sync --group dev

  dev:
    desc: "[Backend] Start development server"
    dir: backend
    cmds:
      - uv run uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload

  lint:
    desc: "[Backend] Run linting with ruff"
    dir: backend
    cmds:
      - uv run ruff check .

  lint:fix:
    desc: "[Backend] Run linting with ruff and auto-fix issues"
    dir: backend
    cmds:
      - uv run ruff check . --fix

  format:
    desc: "[Backend] Format code with ruff"
    dir: backend
    cmds:
      - uv run ruff format .

  format:check:
    desc: "[Backend] Check code formatting without making changes"
    dir: backend
    cmds:
      - uv run ruff format . --check

  test:
    desc: "[Backend] Run tests with pytest"
    dir: backend
    cmds:
      - uv run pytest

  typecheck:
    desc: "[Backend] Run type checking with mypy"
    dir: backend
    cmds:
      - uv run mypy src

  check:all:
    desc: "[Backend] Run all code quality checks (lint, format, typecheck)"
    dir: backend
    cmds:
      - task lint
      - task format:check
      - task typecheck
      - echo "âœ… ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"

  fix:all:
    desc: "[Backend] Auto-fix all possible issues (lint + format)"
    dir: backend
    cmds:
      - echo "ğŸ”§ ã‚³ãƒ¼ãƒ‰å“è³ªã®è‡ªå‹•ä¿®æ­£ã‚’é–‹å§‹..."
      - task lint:fix
      - task format
      - echo "âœ… è‡ªå‹•ä¿®æ­£ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ - task typecheck"

  # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢é€£
  migrate:
    desc: Run auto migration (generate + upgrade)
    dir: backend
    cmds:
      - uv run python -m src.script.auto_migrate

  migrate:generate:
    desc: Generate migration only (no upgrade)
    dir: backend
    cmds:
      - uv run python -m src.script.auto_migrate --no-upgrade

  migrate:status:
    desc: Show migration status
    dir: backend
    cmds:
      - uv run python -m src.script.auto_migrate --status

  migrate:upgrade:
    desc: Upgrade database to latest migration
    dir: backend
    cmds:
      - uv run alembic upgrade head

  migrate:downgrade:
    desc: Safely rollback database by one migration (with file integrity check)
    dir: backend
    cmds:
      - uv run python -m src.script.migration_safety --downgrade

  migrate:downgrade:force:
    desc: Force rollback database by one migration (skip integrity check)
    dir: backend
    cmds:
      - echo "âš ï¸  å¼·åˆ¶å·»ãæˆ»ã—ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰"
      - uv run alembic downgrade -1

  migrate:check:
    desc: Check migration files integrity
    dir: backend
    cmds:
      - uv run python -m src.script.migration_safety --check-only

  migrate:reset:
    desc: Reset database to base (remove all migrations)
    dir: backend
    cmds:
      - echo "âš ï¸  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™"
      - uv run alembic downgrade base
      - echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆå®Œäº†ï¼ˆå…¨ã¦ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼‰"

  migrate:history:
    desc: Show migration history
    dir: backend
    cmds:
      - uv run alembic history

  docker:build:
    desc: "[Backend] Build Docker image"
    cmds:
      - docker compose -f backend/docker/docker-compose.yml build

  docker:up:
    desc: "[Backend] Start Docker containers"
    cmds:
      - docker compose -f backend/docker/docker-compose.yml up

  docker:down:
    desc: "[Backend] Stop Docker containers"
    cmds:
      - docker compose -f backend/docker/docker-compose.yml down

  docker:db:
    desc: "[Backend] Start only database container (lightweight option)"
    cmds:
      - docker compose -f backend/docker/docker-compose.yml up db

  docker:db:detached:
    desc: "[Backend] Start only database container in background"
    cmds:
      - docker compose -f backend/docker/docker-compose.yml up -d db

  clean:
    desc: "[Backend] Clean up generated files"
    dir: backend
    cmds:
      - rm -rf .pytest_cache
      - rm -rf .mypy_cache
      - rm -rf .ruff_cache
      - rm -rf __pycache__
      - find . -name "*.pyc" -delete
      - find . -name "*.pyo" -delete