# テスト・品質保証手順

## タスク完了時の必須手順

### 品質チェック実行順序
1. **自動修正実行**: `task fix:all`
2. **品質チェック**: `task check:all`
3. **テスト実行**: `task test`
4. **ビルド確認**: `task build`

### 個別環境での品質チェック

#### フロントエンド
```bash
cd frontend
task check:fix    # Biome自動修正（unsafe含む）
task format:fix   # Biome自動フォーマット
task typecheck    # TypeScript型チェック
task test         # Vitest実行
```

#### バックエンド
```bash
cd backend  
task lint:fix     # Ruff自動修正
task format       # Ruff自動フォーマット
task typecheck    # mypy型チェック
task test         # pytest実行
```

## テスト戦略

### フロントエンド テスト方針

#### コンポーネントテスト
- **対象**: propsで制御される表示・動作分岐
- **ツール**: Vitest + Testing Library
- **焦点**: UIの正しいレンダリング、インタラクション

#### ロジックテスト
- **対象**: コンポーネントから抽出された純粋関数
- **焦点**: ビジネスロジック、計算処理の正確性
- **構造**: AAA（Arrange-Act-Assert）パターン

#### Storybookテスト
- **目的**: 視覚的確認・ドキュメント化
- **対象**: propsで制御される視覚的バリエーションのみ
- **禁止**: 非視覚的ストーリー（内部状態、ロジック）

#### スナップショットテスト
- **目的**: HTML構造・ARIA属性の意図しない変更検出
- **対象**: セマンティックな構造
- **非推奨**: スタイリング、動的コンテンツ

### バックエンド テスト方針

#### APIテスト
- **対象**: FastAPIエンドポイント
- **検証項目**:
  - HTTPステータスコード
  - レスポンス形式・内容
  - 認証・認可動作
  - エラーハンドリング

#### サービステスト
- **対象**: ビジネスロジック層
- **焦点**: 純粋なビジネスルール検証
- **分離**: データベース操作から独立

#### モデルテスト
- **対象**: Pydanticモデル
- **検証項目**:
  - バリデーション動作
  - デフォルト値設定
  - 型変換処理
  - エラーメッセージ

#### データベーステスト
- **対象**: SQLAlchemy操作
- **検証項目**:
  - CRUD操作
  - トランザクション動作
  - 制約違反処理
  - パフォーマンス

## テスト構造・品質基準

### テストタイトル規則
- **日本語必須**: 全テストタイトルは日本語
- **具体性**: 条件と期待結果を明確に記述
- **形式**: 「〜の場合、〜すること」「〜の時、〜されること」

### テスト構造ルール
1. **AAAパターン**: Arrange-Act-Assert構造
2. **単一責任**: 1テストで1つの検証
3. **変数命名**: `actual`（実際の結果）、`expected`（期待値）
4. **コメント禁止**: 自明なコメント（Arrange, Act, Assert）は不要

### 品質メトリクス目標

#### フロントエンド
- **ロジック関数**: 100%カバレッジ
- **コンポーネント**: 重要分岐網羅
- **プロジェクト全体**: 80%以上
- **コード重複**: similarity-ts 80%未満維持

#### バックエンド  
- **APIエンドポイント**: 100%カバレッジ
- **サービス層**: 90%以上
- **データベース層**: 85%以上
- **ユーティリティ**: 100%カバレッジ
- **プロジェクト全体**: 85%以上

## 品質ツール設定

### フロントエンド品質設定

#### Biome設定（biome.json）
```json
{
  "linter": { "enabled": true },
  "formatter": { "enabled": true },
  "organizeImports": { "enabled": true }
}
```

#### TypeScript設定
- 厳格モード有効
- 全関数に型アノテーション必須
- `any`型使用禁止（例外的な場合除く）

### バックエンド品質設定

#### Ruff設定（pyproject.toml）
```toml
[tool.ruff.lint]
select = ["E", "W", "F", "I", "B", "C4", "UP"]
line-length = 88
```

#### mypy設定
```toml  
[tool.mypy]
strict = true
disallow_untyped_defs = true
warn_return_any = true
```

## Git Hooks品質保証

### pre-commit処理
1. **Biome自動修正**: フロントエンドコード
2. **Ruff自動修正**: バックエンドコード  
3. **型チェック**: TypeScript + mypy
4. **重複検出**: similarity-ts実行
5. **修正内容ステージ**: 自動修正をコミットに含める

### pre-push処理
1. **ビルドテスト**: 基本的なビルド可能性確認
2. **CI/CD整合性**: 本番環境との一貫性チェック

## エラー対処フロー

### 品質チェック失敗時
1. **自動修正実行**: `task fix:all`
2. **個別エラー確認**: `task check:all`で詳細確認
3. **手動修正**: 型エラー・リンティングエラー対応
4. **再チェック**: 修正後に品質チェック再実行

### よくあるエラーパターン

#### TypeScript型エラー
- 型アノテーション不足
- `any`型の不適切な使用
- 戻り値型の未指定

#### Python型エラー  
- 関数引数・戻り値の型アノテーション不足
- Pydanticモデル定義不備
- Optional型の不適切な使用

#### リンティングエラー
- コードスタイル不統一
- 未使用変数・インポート
- 複雑度過多の関数

### 重複コード対処
- **抽出**: 共通ロジックを関数・モジュール化
- **リファクタリング**: 類似パターンの統一
- **設計見直し**: アーキテクチャレベルでの改善

## 継続的品質改善

### 定期メンテナンス
- **月次**: 依存関係更新
- **四半期**: コーディング規約見直し  
- **半期**: メトリクス分析・改善計画

### 品質向上プラクティス
- **コードレビュー**: Pull Request相互レビュー
- **ペアプログラミング**: 複雑ロジック実装時
- **リファクタリング**: 技術的負債の継続解消
- **知識共有**: 品質基準の定期的な共有・更新