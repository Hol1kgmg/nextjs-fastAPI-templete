version: '3'

# çµ±åˆã‚¿ã‚¹ã‚¯ï¼ˆãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ - ä¸¡æ–¹å®Ÿè¡Œï¼‰
tasks:
  list:
    desc: "task command lists"
    cmds:
      - task --list
  install:
    desc: "[Fullstack] Install all dependencies"
    cmds:
      - task install:backend
      - task install:frontend

  dev:
    desc: "[Fullstack] Start both frontend and backend development servers"
    deps: [dev:backend, dev:frontend]

  build:
    desc: "[Fullstack] Build both frontend and backend"
    cmds:
      - task build:backend
      - task build:frontend

  test:
    desc: "[Fullstack] Run all tests"
    cmds:
      - task test:backend
      - task test:frontend

  check:all:
    desc: "[Fullstack] Run all quality checks"
    cmds:
      - task check:backend
      - task check:frontend

  clean:
    desc: "[Fullstack] Clean all generated files"
    cmds:
      - task clean:backend
      - task clean:frontend

  # Dockerçµ±åˆã‚¿ã‚¹ã‚¯ï¼ˆå…¨ç’°å¢ƒï¼‰
  docker:build:
    desc: "[Docker] Build all Docker images"
    cmds:
      - task docker:build:backend
      - task docker:build:frontend

  docker:up:
    desc: "[Docker] Start all Docker environments"
    cmds:
      - task docker:up:backend
      - task docker:up:frontend

  docker:down:
    desc: "[Docker] Stop all Docker environments"
    cmds:
      - task docker:down:backend
      - task docker:down:frontend

  # Dockerå€‹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ã‚¿ã‚¹ã‚¯
  docker:up:db:
    desc: "[Docker] Start database container only (detached)"
    dir: backend
    cmds:
      - docker-compose -f docker/docker-compose.yml up -d db
      - echo "âœ… Database container started in background"
      - echo "ğŸ“‹ Use 'task docker:logs:db' to view logs"
      - echo "ğŸ›‘ Use 'task docker:down:backend' to stop"

  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å€‹åˆ¥ã‚¿ã‚¹ã‚¯
  install:backend:
    desc: "[Backend] Install dependencies using uv"
    dir: backend
    cmds:
      - uv sync --group dev

  dev:backend:
    desc: "[Backend] Start development server"
    dir: backend
    cmds:
      - uv run uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload

  build:backend:
    desc: "[Backend] Build backend (placeholder)"
    dir: backend
    cmds:
      - echo "Backend build completed"

  test:backend:
    desc: "[Backend] Run tests with pytest"
    dir: backend
    cmds:
      - uv run pytest

  check:backend:
    desc: "[Backend] Run all code quality checks"
    dir: backend
    cmds:
      - uv run ruff check .
      - uv run ruff format . --check
      - uv run mypy src

  clean:backend:
    desc: "[Backend] Clean generated files"
    dir: backend
    cmds:
      - rm -rf .pytest_cache .mypy_cache .ruff_cache __pycache__
      - find . -name "*.pyc" -delete

  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰Dockerå€‹åˆ¥ã‚¿ã‚¹ã‚¯
  docker:build:backend:
    desc: "[Backend] Build backend Docker image"
    dir: backend
    cmds:
      - docker-compose -f docker/docker-compose.yml build

  docker:up:backend:
    desc: "[Backend] Start backend Docker environment"
    dir: backend
    cmds:
      - docker-compose -f docker/docker-compose.yml up

  docker:down:backend:
    desc: "[Backend] Stop backend Docker environment (includes database)"
    dir: backend
    cmds:
      - docker-compose -f docker/docker-compose.yml down

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å€‹åˆ¥ã‚¿ã‚¹ã‚¯
  install:frontend:
    desc: "[Frontend] Install dependencies using Bun"
    dir: frontend
    cmds:
      - bun install

  dev:frontend:
    desc: "[Frontend] Start development server"
    dir: frontend
    cmds:
      - bun run dev

  build:frontend:
    desc: "[Frontend] Build production application"
    dir: frontend
    cmds:
      - bun run build

  test:frontend:
    desc: "[Frontend] Run tests"
    dir: frontend
    cmds:
      - bun run test

  check:frontend:
    desc: "[Frontend] Run all quality checks"
    dir: frontend
    cmds:
      - bun run check
      - bun run format
      - bun run typecheck

  clean:frontend:
    desc: "[Frontend] Clean generated files"
    dir: frontend
    cmds:
      - rm -rf .next node_modules/.cache dist storybook-static

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰Dockerå€‹åˆ¥ã‚¿ã‚¹ã‚¯
  docker:build:frontend:
    desc: "[Frontend] Build frontend Docker image"
    dir: frontend
    cmds:
      - docker-compose -f docker/docker-compose.yml build

  docker:up:frontend:
    desc: "[Frontend] Start frontend Docker environment"
    dir: frontend
    cmds:
      - docker-compose -f docker/docker-compose.yml up

  docker:down:frontend:
    desc: "[Frontend] Stop frontend Docker environment"
    dir: frontend
    cmds:
      - docker-compose -f docker/docker-compose.yml down

  # è¿½åŠ ã®Dockerä¾¿åˆ©ã‚¿ã‚¹ã‚¯
  docker:logs:db:
    desc: "[Docker] Show database container logs"
    dir: backend
    cmds:
      - docker-compose -f docker/docker-compose.yml logs -f db

  docker:restart:db:
    desc: "[Docker] Restart database container"
    dir: backend
    cmds:
      - docker-compose -f docker/docker-compose.yml restart db

  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢é€£ï¼ˆå€‹åˆ¥ã‚¿ã‚¹ã‚¯ã¨ã—ã¦ç¶­æŒï¼‰
  migrate:
    desc: "[Backend] Run auto migration (generate + upgrade)"
    dir: backend
    cmds:
      - uv run python -m src.script.auto_migrate

  migrate:generate:
    desc: "[Backend] Generate migration only (no upgrade)"
    dir: backend
    cmds:
      - uv run python -m src.script.auto_migrate --no-upgrade

  migrate:status:
    desc: "[Backend] Show migration status"
    dir: backend
    cmds:
      - uv run python -m src.script.auto_migrate --status

  migrate:upgrade:
    desc: "[Backend] Upgrade database to latest migration"
    dir: backend
    cmds:
      - uv run alembic upgrade head

  migrate:downgrade:
    desc: "[Backend] Safely rollback database by one migration"
    dir: backend
    cmds:
      - uv run python -m src.script.migration_safety --downgrade

  migrate:check:
    desc: "[Backend] Check migration files integrity"
    dir: backend
    cmds:
      - uv run python -m src.script.migration_safety --check-only

  migrate:reset:
    desc: "[Backend] Reset database to base (remove all migrations)"
    dir: backend
    cmds:
      - echo "âš ï¸  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™"
      - uv run alembic downgrade base
      - echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆå®Œäº†"

  migrate:history:
    desc: "[Backend] Show migration history"
    dir: backend
    cmds:
      - uv run alembic history